<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سیستم حسابداری Tellmart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { direction: rtl; font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
    th { background-color: #f2f2f2; }
    .hidden { display: none; }
    .disabled { opacity: 0.5; pointer-events: none; }
    .nested { margin-right: 20px; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <!-- صفحه لاگین -->
  <div id="loginPage" class="max-w-md mx-auto bg-white p-6 rounded shadow-md">
    <h1 class="text-2xl font-bold mb-4">ورود به سیستم</h1>
    <div class="mb-4">
      <label class="block mb-1">نام کاربری:</label>
      <input type="text" id="username" class="border p-2 w-full">
    </div>
    <div class="mb-4">
      <label class="block mb-1">رمز عبور:</label>
      <input type="password" id="password" class="border p-2 w-full">
    </div>
    <button onclick="login()" class="bg-blue-500 text-white p-2 w-full">ورود</button>
  </div>

  <!-- صفحه اصلی (فرم تراکنش‌ها) -->
  <div id="mainPage" class="hidden">
    <div class="flex justify-between mb-4">
      <h1 class="text-2xl font-bold">ثبت تراکنش‌های Tellmart</h1>
      <div>
        <button onclick="showReports()" class="bg-purple-500 text-white p-2">مشاهده گزارش‌ها</button>
        <button id="dataEntryButton" onclick="showDataEntry()" class="bg-yellow-500 text-white p-2 hidden">مدیریت داده‌ها</button>
        <button onclick="logout()" class="bg-red-500 text-white p-2">خروج</button>
      </div>
    </div>
    <div class="mb-4">
      <label>جسسستجو:</label>
      <input type="text" id="searchTransactions" class="border p-2 w-full" placeholder="حساب، بابت، یا شماره رسید" oninput="filterTransactions()">
    </div>
    <table id="transactionTable" class="bg-white shadow-md rounded">
      <thead>
        <tr>
          <th>شروع</th>
          <th>جزئیات</th>
        </tr>
      </thead>
      <tbody id="transactionBody">
        <tr id="row1">
          <td><button onclick="startForm(1)" class="bg-green-500 text-white p-2">شروع</button></td>
          <td>
            <div id="form1" class="p-2 hidden">
              <!-- مرحله 1: نوع تراکنش -->
              <div id="step1_1" class="mb-2">
                <label id="stage1Label">مرحله 1: نوع تراکنش</label>
                <select id="type1" onchange="showTypeOptions(1)" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="nextStep(1, 1, 2)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 2: دسته‌بندی -->
              <div id="step2_1" class="hidden mb-2">
                <label id="stage2Label">مرحله 2: دسته‌بندی</label>
                <select id="category1" onchange="updateReasonOptions(1)" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(1, 2, 1)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 2, 3)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 3: مبلغ -->
              <div id="step3_1" class="hidden mb-2">
                <label id="stage3Label">مرحله 3: مبلغ (ریال)</label>
                <input type="text" id="amount1" oninput="formatAmount(1)" class="border p-2 w-full" placeholder="مثال: 200,000">
                <p id="amountText1" class="text-sm text-gray-600 mt-1"></p>
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="confirmAmount1" class="mr-2">
                  <span>مبلغ واردشده درست است</span>
                </label>
                <button onclick="goBack(1, 3, 2)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 3, 4)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 4: بابت -->
              <div id="step4_1" class="hidden mb-2">
                <label id="stage4Label">مرحله 4: بابت</label>
                <select id="reason1" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(1, 4, 3)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 4, 5)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 5: حساب مبدا و مقصد -->
              <div id="step5_1" class="hidden mb-2">
                <label id="stage5SourceLabel">مرحله 5: حساب مبدا</label>
                <select id="sourceAccount1" class="border p-2 w-full mb-2">
                  <option value="">انتخاب کنید</option>
                </select>
                <label id="stage5DestLabel">حساب مقصد</label>
                <select id="destAccount1" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(1, 5, 4)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 5, 6)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 6: شماره فاکتور/رسید -->
              <div id="step6_1" class="hidden mb-2">
                <label id="stage6Label">مرحله 6: شماره فاکتور/رسید</label>
                <input type="text" id="invoice1" class="border p-2 w-full">
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="noInvoice1" class="mr-2" onchange="toggleInvoice(1)">
                  <span>فاقد شماره فاکتور/رسید</span>
                </label>
                <button onclick="goBack(1, 6, 5)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 6, 7)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 7: آپلود مدارک -->
              <div id="step7_1" class="hidden mb-2">
                <label id="stage7Label">مرحله 7: آپلود مدارک</label>
                <input type="file" id="document1" class="border p-2 w-full">
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="noDocument1" class="mr-2" onchange="toggleDocument(1)">
                  <span>فاقد مدارک</span>
                </label>
                <button onclick="goBack(1, 7, 6)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(1, 7, 8)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <!-- مرحله 8: توضیحات -->
              <div id="step8_1" class="hidden mb-2">
                <label id="stage8Label">مرحله 8: توضیحات</label>
                <textarea id="description1" class="border p-2 w-full" rows="4" placeholder="توضیحات (اختیاری)"></textarea>
                <button onclick="goBack(1, 8, 7)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="saveTransaction(1)" class="bg-green-500 text-white p-2 mt-2">مرحله 9: پایان</button>
              </div>
              <button onclick="deleteRow(1)" class="bg-red-500 text-white p-2 mt-2">حذف ردیف</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <button id="addRowButton" onclick="addRow()" class="bg-green-500 text-white p-2 mt-4 disabled">اضافه کردن ردیف جدید</button>
    <div class="mt-4">
      <h2 class="text-xl font-bold mb-2">تراکنش‌های ذخیره‌شده</h2>
      <table id="savedTransactions" class="bg-white shadow-md rounded">
        <thead>
          <tr>
            <th>ردیف</th>
            <th>نوع</th>
            <th>دسته‌بندی</th>
            <th>مبلغ (تومان)</th>
            <th>بابت</th>
            <th>حساب مبدا</th>
            <th>حساب مقصد</th>
            <th>فاکتور/رسید</th>
            <th>توضیحات</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody id="savedTransactionsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- صفحه مدیریت داده‌ها -->
  <div id="dataEntryPage" class="hidden">
    <div class="flex justify-between mb-4">
      <h1 class="text-2xl font-bold">مدیریت داده‌های ورودی</h1>
      <div>
        <button onclick="showMainPage()" class="bg-blue-500 text-white p-2">بازگشت به فرم</button>
        <button onclick="logout()" class="bg-red-500 text-white p-2">خروج</button>
      </div>
    </div>
    <div id="stagesManagement"></div>
  </div>

  <!-- صفحه گزارش -->
  <div id="reportPage" class="hidden">
    <div class="flex justify-between mb-4">
      <h1 class="text-2xl font-bold">گزارش تراکنش‌ها</h1>
      <div>
        <button onclick="showMainPage()" class="bg-blue-500 text-white p-2">بازگشت به فرم</button>
        <button onclick="logout()" class="bg-red-500 text-white p-2">خروج</button>
      </div>
    </div>
    <div class="mb-4">
      <label>جستجوی شماره فاکتور/رسید:</label>
      <input type="text" id="searchInvoice" class="border p-2 w-full" oninput="filterReports()">
    </div>
    <table id="reportTable" class="bg-white shadow-md rounded">
      <thead>
        <tr>
          <th>کاربر</th>
          <th>تاریخ</th>
          <th>نوع</th>
          <th>دسته‌بندی</th>
          <th>مبلغ (تومان)</th>
          <th>بابت</th>
          <th>حساب مبدا</th>
          <th>حساب مقصد</th>
          <th>فاکتور/رسید</th>
          <th>توضیحات</th>
        </tr>
      </thead>
      <tbody id="reportBody"></tbody>
    </table>
  </div>

  <script>
    // تعریف کاربران
    const users = [
      { username: 'roozbeh', password: 'roozbeh', access: ['form', 'dataEntry', 'reports'] },
      { username: 'ramtin', password: 'ramtin', access: ['form', 'reports'] },
      { username: 'saeed', password: 'saeed', access: ['form', 'reports'] },
      { username: 'majid', password: 'majid', access: ['form', 'reports'] }
    ];

    // شبیه‌سازی دیتابیس با JSON
    let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
    let logs = JSON.parse(localStorage.getItem('logs')) || [];
    let stages = JSON.parse(localStorage.getItem('stages')) || [
      {
        id: 1,
        title: 'نوع تراکنش',
        type: 'select',
        options: [
          { value: 'واریز', label: 'واریز شده به حساب' },
          { value: 'برداشت', label: 'برداشت شده از حساب' },
          { value: 'تهاتری', label: 'تراکنش تهاتری' }
        ]
      },
      {
        id: 2,
        title: 'دسته‌بندی',
        type: 'select',
        options: {
          'واریز': [
            { value: 'درآمد', label: 'درآمد' },
            { value: 'افزایش سرمایه', label: 'افزایش سرمایه' }
          ],
          'برداشت': [
            { value: 'هزینه', label: 'هزینه' },
            { value: 'کاهش سرمایه', label: 'کاهش سرمایه' }
          ],
          'تهاتری': [
            { value: 'درآمد و هزینه', label: 'درآمد و هزینه' }
          ]
        }
      },
      {
        id: 3,
        title: 'مبلغ (ریال)',
        type: 'text'
      },
      {
        id: 4,
        title: 'بابت',
        type: 'select',
        options: {
          'واریز': {
            'درآمد': ['فروش سایت', 'فروش به خطیب'],
            'افزایش سرمایه': ['سرمایه‌گذاری']
          },
          'برداشت': {
            'هزینه': ['اجاره', 'خرید کالا'],
            'کاهش سرمایه': ['بازگشت سرمایه']
          },
          'تهاتری': {
            'درآمد و هزینه': [
              { income: 'فروش به خطیب', cost: 'تسویه با حامد' }
            ]
          }
        }
      },
      {
        id: 5,
        title: 'حساب‌ها',
        type: 'double-select',
        sourceAccounts: ['پاسارگاد شرکت', 'نسرین', 'رامتین', 'تنخواه سعید', 'خطیب'],
        destAccounts: ['صادرات یامی', 'تجارت خطیب', 'تات رامتین', 'حامد']
      },
      {
        id: 6,
        title: 'شماره فاکتور/رسید',
        type: 'text-checkbox',
        options: [{ value: 'no-invoice', label: 'فاقد شماره فاکتور/رسید' }]
      },
      {
        id: 7,
        title: 'آپلود مدارک',
        type: 'file-checkbox',
        options: [{ value: 'no-document', label: 'فاقد مدارک' }]
      },
      {
        id: 8,
        title: 'توضیحات',
        type: 'textarea'
      },
      {
        id: 9,
        title: 'پایان',
        type: 'button'
      }
    ];
    let isFormActive = false;
    let currentUser = null;

    // چک کردن لاگین هنگام لود صفحه
    window.onload = function() {
      const loginData = JSON.parse(localStorage.getItem('loginData'));
      if (loginData) {
        const now = new Date().getTime();
        const loginTime = loginData.loginTime;
        const timeDiff = now - loginTime;
        const hours24 = 24 * 60 * 60 * 1000; // 24 ساعت به میلی‌ثانیه
        if (timeDiff < hours24) {
          currentUser = loginData.user;
          document.getElementById('loginPage').classList.add('hidden');
          document.getElementById('mainPage').classList.remove('hidden');
          if (currentUser.access.includes('dataEntry')) {
            document.getElementById('dataEntryButton').classList.remove('hidden');
          }
          initializeForm(1);
        } else {
          localStorage.removeItem('loginData');
        }
      }
    };

    // شبیه‌سازی لاگین
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const user = users.find(u => u.username === username && u.password === password);
      if (user) {
        currentUser = user;
        const loginData = {
          user: user,
          loginTime: new Date().getTime()
        };
        localStorage.setItem('loginData', JSON.stringify(loginData));
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainPage').classList.remove('hidden');
        if (user.access.includes('dataEntry')) {
          document.getElementById('dataEntryButton').classList.remove('hidden');
        }
        initializeForm(1);
      } else {
        alert('نام کاربری یا رمز عبور اشتباه است');
      }
    }

    // خروج از سیستم
    function logout() {
      localStorage.removeItem('loginData');
      currentUser = null;
      document.getElementById('mainPage').classList.add('hidden');
      document.getElementById('dataEntryPage').classList.add('hidden');
      document.getElementById('reportPage').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // تبدیل عدد به حروف
    function numberToWords(num) {
      if (num === 0) return 'صفر';
      const units = ['', 'یک', 'دو', 'سه', 'چهار', 'پنج', 'شش', 'هفت', 'هشت', 'نه'];
      const teens = ['ده', 'یازده', 'دوازده', 'سیزده', 'چهارده', 'پانزده', 'شانزده', 'هفده', 'هجده', 'نوزده'];
      const tens = ['', 'ده', 'بیست', 'سی', 'چهل', 'پنجاه', 'شصت', 'هفتاد', 'هشتاد', 'نود'];
      const hundreds = ['', 'صد', 'دویست', 'سیصد', 'چهارصد', 'پانصد', 'ششصد', 'هفتصد', 'هشتصد', 'نهصد'];
      const thousands = ['', 'هزار', 'میلیون', 'میلیارد'];

      function convertChunk(n) {
        let result = '';
        if (n >= 100) {
          result += hundreds[Math.floor(n / 100)] + ' ';
          n %= 100;
        }
        if (n >= 20) {
          result += tens[Math.floor(n / 10)] + ' ';
          n %= 10;
        } else if (n >= 10) {
          result += teens[n - 10] + ' ';
          return result.trim();
        }
        if (n > 0) {
          result += units[n] + ' ';
        }
        return result.trim();
      }

      let result = '';
      let chunkIndex = 0;
      while (num > 0) {
        let chunk = num % 1000;
        if (chunk > 0) {
          result = convertChunk(chunk) + ' ' + thousands[chunkIndex] + ' ' + result;
        }
        num = Math.floor(num / 1000);
        chunkIndex++;
      }
      return result.trim();
    }

    // فرمت کردن مبلغ با ویرگول
    function formatAmount(rowId) {
      let input = document.getElementById(`amount${rowId}`);
      let value = input.value.replace(/,/g, '');
      if (value && !isNaN(value)) {
        input.value = Number(value).toLocaleString('en-US');
        let toman = Math.floor(value / 10); // تبدیل به تومان
        document.getElementById(`amountText${rowId}`).innerText = `${numberToWords(toman)} تومان`;
      } else {
        document.getElementById(`amountText${rowId}`).innerText = '';
      }
    }

    // مقداردهی اولیه فرم
    function initializeForm(rowId) {
      const typeSelect = document.getElementById(`type${rowId}`);
      typeSelect.innerHTML = '<option value="">انتخاب کنید</option>';
      stages.find(s => s.id === 1).options.forEach(opt => {
        typeSelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
      });
      stages.forEach(stage => {
        if (stage.id <= 8) {
          document.getElementById(`stage${stage.id}Label`).innerText = `مرحله ${stage.id}: ${stage.title}`;
        }
        if (stage.id === 5) {
          document.getElementById(`stage5SourceLabel`).innerText = `مرحله 5: حساب مبدا`;
          document.getElementById(`stage5DestLabel`).innerText = `حساب مقصد`;
        }
      });
      updateAccountOptions(rowId);
    }

    // شروع فرم
    function startForm(rowId) {
      if (isFormActive) {
        alert('لطفاً فرم فعلی را ذخیره کنید');
        return;
      }
      isFormActive = true;
      document.getElementById(`form${rowId}`).classList.remove('hidden');
      document.getElementById('addRowButton').classList.add('disabled');
      console.log(`شروع ردیف ${rowId} در تاریخ: ${new Date()}`);
    }

    // نمایش گزینه‌های دسته‌بندی
    function showTypeOptions(rowId) {
      const type = document.getElementById(`type${rowId}`).value;
      const categorySelect = document.getElementById(`category${rowId}`);
      categorySelect.innerHTML = '<option value="">انتخاب کنید</option>';
      const stage2 = stages.find(s => s.id === 2);
      if (type && stage2.options[type]) {
        stage2.options[type].forEach(opt => {
          categorySelect.innerHTML += `<option value="${opt.value}">${opt.label}</option>`;
        });
      }
      updateReasonOptions(rowId);
    }

    // به‌روزرسانی گزینه‌های بابت
    function updateReasonOptions(rowId) {
      const type = document.getElementById(`type${rowId}`).value;
      const category = document.getElementById(`category${rowId}`).value;
      const reasonSelect = document.getElementById(`reason${rowId}`);
      reasonSelect.innerHTML = '<option value="">انتخاب کنید</option>';
      const stage4 = stages.find(s => s.id === 4);
      if (type && category && stage4.options[type] && stage4.options[type][category]) {
        if (type === 'تهاتری') {
          document.getElementById(`reasonLabel${rowId}`).innerText = `مرحله 4: بابت درآمد`;
          stage4.options[type][category].forEach(item => {
            reasonSelect.innerHTML += `<option value="${item.income}">${item.income}</option>`;
          });
        } else {
          document.getElementById(`reasonLabel${rowId}`).innerText = `مرحله 4: ${stage4.title}`;
          stage4.options[type][category].forEach(reason => {
            reasonSelect.innerHTML += `<option value="${reason}">${reason}</option>`;
          });
        }
      }
    }

    // به‌روزرسانی گزینه‌های حساب
    function updateAccountOptions(rowId) {
      const sourceAccountSelect = document.getElementById(`sourceAccount${rowId}`);
      const destAccountSelect = document.getElementById(`destAccount${rowId}`);
      sourceAccountSelect.innerHTML = '<option value="">انتخاب کنید</option>';
      destAccountSelect.innerHTML = '<option value="">انتخاب کنید</option>';
      const stage5 = stages.find(s => s.id === 5);
      stage5.sourceAccounts.forEach(account => {
        sourceAccountSelect.innerHTML += `<option value="${account}">${account}</option>`;
      });
      stage5.destAccounts.forEach(account => {
        destAccountSelect.innerHTML += `<option value="${account}">${account}</option>`;
      });
    }

    // غیرفعال کردن ورودی فاکتور
    function toggleInvoice(rowId) {
      const noInvoice = document.getElementById(`noInvoice${rowId}`).checked;
      document.getElementById(`invoice${rowId}`).disabled = noInvoice;
      if (noInvoice) document.getElementById(`invoice${rowId}`).value = '';
    }

    // غیرفعال کردن آپلود مدارک
    function toggleDocument(rowId) {
      const noDocument = document.getElementById(`noDocument${rowId}`).checked;
      document.getElementById(`document${rowId}`).disabled = noDocument;
      if (noDocument) document.getElementById(`document${rowId}`).value = '';
    }

    // رفتن به مرحله بعدی
    function nextStep(rowId, currentStep, nextStep) {
      let valid = false;
      const type = document.getElementById(`type${rowId}`).value;
      if (currentStep === 1) {
        valid = type !== '';
      } else if (currentStep === 2) {
        valid = document.getElementById(`category${rowId}`).value !== '';
      } else if (currentStep === 3) {
        valid = document.getElementById(`amount${rowId}`).value !== '' && document.getElementById(`confirmAmount${rowId}`).checked;
      } else if (currentStep === 4) {
        valid = document.getElementById(`reason${rowId}`).value !== '';
      } else if (currentStep === 5) {
        valid = document.getElementById(`sourceAccount${rowId}`).value !== '' && document.getElementById(`destAccount${rowId}`).value !== '';
      } else if (currentStep === 6) {
        valid = document.getElementById(`noInvoice${rowId}`).checked || document.getElementById(`invoice${rowId}`).value !== '';
      } else if (currentStep === 7) {
        valid = document.getElementById(`noDocument${rowId}`).checked || document.getElementById(`document${rowId}`).files.length > 0;
      }
      if (!valid) {
        alert('لطفاً این مرحله را کامل کنید');
        return;
      }
      document.getElementById(`step${currentStep}_${rowId}`).classList.add('hidden');
      document.getElementById(`step${nextStep}_${rowId}`).classList.remove('hidden');
    }

    // بازگشت به مرحله قبل
    function goBack(rowId, currentStep, prevStep) {
      document.getElementById(`step${currentStep}_${rowId}`).classList.add('hidden');
      document.getElementById(`step${prevStep}_${rowId}`).classList.remove('hidden');
    }

    // حذف ردیف
    function deleteRow(rowId) {
      if (confirm('آیا از حذف این ردیف مطمئن هستید؟')) {
        document.getElementById(`row${rowId}`).remove();
        transactions = transactions.filter(t => t.rowId !== rowId);
        localStorage.setItem('transactions', JSON.stringify(transactions));
        isFormActive = false;
        document.getElementById('addRowButton').classList.remove('disabled');
        updateSavedTransactions();
        updateReports();
      }
    }

    // ذخیره تراکنش
    function saveTransaction(rowId, isEdit = false) {
      const type = document.getElementById(`type${rowId}`).value;
      const description = document.getElementById(`description${rowId}`).value;
      const transaction = {
        rowId,
        username: currentUser.username,
        date: new Date().toISOString(),
        type,
        category: document.getElementById(`category${rowId}`).value,
        amount: document.getElementById(`amount${rowId}`).value.replace(/,/g, ''),
        reason: document.getElementById(`reason${rowId}`).value,
        sourceAccount: document.getElementById(`sourceAccount${rowId}`).value,
        destAccount: document.getElementById(`destAccount${rowId}`).value,
        invoice: document.getElementById(`noInvoice${rowId}`).checked ? '' : document.getElementById(`invoice${rowId}`).value,
        document: '',
        description
      };
      const documentFile = document.getElementById(`document${rowId}`).files[0];
      const save = () => {
        if (isEdit) {
          const index = transactions.findIndex(t => t.rowId === rowId);
          transactions[index] = transaction;
          logs.push({
            rowId,
            username: currentUser.username,
            date: new Date().toISOString(),
            action: 'ویرایش',
            details: `ردیف ${rowId} ویرایش شد`
          });
        } else {
          transactions.push(transaction);
          logs.push({
            rowId,
            username: currentUser.username,
            date: new Date().toISOString(),
            action: 'ایجاد',
            details: `ردیف ${rowId} ایجاد شد`
          });
        }
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('logs', JSON.stringify(logs));
        isFormActive = false;
        document.getElementById('addRowButton').classList.remove('disabled');
        document.getElementById(`form${rowId}`).classList.add('hidden');
        updateSavedTransactions();
        updateReports();
        alert('تراکنش با موفقیت ذخیره شد');
      };
      if (documentFile && !document.getElementById(`noDocument${rowId}`).checked) {
        const reader = new FileReader();
        reader.onload = function(e) {
          transaction.document = e.target.result; // Base64
          save();
        };
        reader.readAsDataURL(documentFile);
      } else {
        save();
      }
    }

    // ویرایش تراکنش
    function editTransaction(rowId) {
      if (isFormActive) {
        alert('لطفاً فرم فعلی را ذخیره کنید');
        return;
      }
      isFormActive = true;
      document.getElementById('addRowButton').classList.add('disabled');
      const transaction = transactions.find(t => t.rowId === rowId);
      const formId = rowId;
      document.getElementById(`form${formId}`).classList.remove('hidden');
      document.getElementById(`type${formId}`).value = transaction.type;
      showTypeOptions(formId);
      document.getElementById(`category${formId}`).value = transaction.category;
      updateReasonOptions(formId);
      document.getElementById(`reason${formId}`).value = transaction.reason;
      document.getElementById(`amount${formId}`).value = Number(transaction.amount).toLocaleString('en-US');
      formatAmount(formId);
      document.getElementById(`sourceAccount${formId}`).value = transaction.sourceAccount;
      document.getElementById(`destAccount${formId}`).value = transaction.destAccount;
      document.getElementById(`invoice${formId}`).value = transaction.invoice;
      document.getElementById(`noInvoice${formId}`).checked = !transaction.invoice;
      toggleInvoice(formId);
      document.getElementById(`noDocument${formId}`).checked = !transaction.document;
      toggleDocument(formId);
      document.getElementById(`description${formId}`).value = transaction.description;
      document.getElementById(`step1_${formId}`).classList.remove('hidden');
    }

    // به‌روزرسانی جدول تراکنش‌های ذخیره‌شده
    function updateSavedTransactions() {
      const savedBody = document.getElementById('savedTransactionsBody');
      savedBody.innerHTML = '';
      const search = document.getElementById('searchTransactions').value.toLowerCase();
      transactions.filter(t => {
        return !search || 
          t.sourceAccount.toLowerCase().includes(search) ||
          t.destAccount.toLowerCase().includes(search) ||
          t.reason.toLowerCase().includes(search) ||
          t.invoice.toLowerCase().includes(search);
      }).forEach(t => {
        const row = savedBody.insertRow();
        row.innerHTML = `
          <td>${t.rowId}</td>
          <td>${stages.find(s => s.id === 1).options.find(o => o.value === t.type)?.label || t.type}</td>
          <td>${t.category}</td>
          <td>${(t.amount / 10).toLocaleString('en-US')}</td>
          <td>${t.reason}</td>
          <td>${t.sourceAccount}</td>
          <td>${t.destAccount}</td>
          <td>${t.invoice || 'فاقد'}</td>
          <td>${t.description || 'بدون توضیح'}</td>
          <td><button onclick="editTransaction(${t.rowId})" class="bg-yellow-500 text-white p-1">ویرایش</button></td>
        `;
      });
    }

    // فیلتر تراکنش‌ها
    function filterTransactions() {
      updateSavedTransactions();
    }

    // نمایش صفحه گزارش
    function showReports() {
      if (!currentUser.access.includes('reports')) {
        alert('شما دسترسی به این صفحه ندارید');
        return;
      }
      document.getElementById('mainPage').classList.add('hidden');
      document.getElementById('dataEntryPage').classList.add('hidden');
      document.getElementById('reportPage').classList.remove('hidden');
      updateReports();
    }

    // نمایش صفحه داده‌های ورودی
    function showDataEntry() {
      if (!currentUser.access.includes('dataEntry')) {
        alert('شما دسترسی به این صفحه ندارید');
        return;
      }
      document.getElementById('mainPage').classList.add('hidden');
      document.getElementById('reportPage').classList.add('hidden');
      document.getElementById('dataEntryPage').classList.remove('hidden');
      updateDataEntry();
    }

    // بازگشت به صفحه اصلی
    function showMainPage() {
      document.getElementById('reportPage').classList.add('hidden');
      document.getElementById('dataEntryPage').classList.add('hidden');
      document.getElementById('mainPage').classList.remove('hidden');
      refreshForm();
    }

    // به‌روزرسانی گزارش‌ها
    function updateReports() {
      const reportBody = document.getElementById('reportBody');
      reportBody.innerHTML = '';
      const searchInvoice = document.getElementById('searchInvoice').value.toLowerCase();
      transactions.filter(t => !searchInvoice || t.invoice.toLowerCase().includes(searchInvoice)).forEach(t => {
        const row = reportBody.insertRow();
        row.innerHTML = `
          <td>${t.username}</td>
          <td>${new Date(t.date).toLocaleDateString('fa-IR')}</td>
          <td>${stages.find(s => s.id === 1).options.find(o => o.value === t.type)?.label || t.type}</td>
          <td>${t.category}</td>
          <td>${(t.amount / 10).toLocaleString('en-US')}</td>
          <td>${t.reason}</td>
          <td>${t.sourceAccount}</td>
          <td>${t.destAccount}</td>
          <td>${t.invoice || 'فاقد'}</td>
          <td>${t.description || 'بدون توضیح'}</td>
        `;
      });
    }

    // به‌روزرسانی صفحه مدیریت داده‌ها
    function updateDataEntry() {
      const container = document.getElementById('stagesManagement');
      container.innerHTML = '';
      stages.forEach(stage => {
        const div = document.createElement('div');
        div.className = 'mb-6';
        div.innerHTML = `
          <h2 class="text-lg font-bold mb-2">مدیریت مرحله ${stage.id}: ${stage.title}</h2>
          <div class="mb-2">
            <label>عنوان مرحله:</label>
            <input type="text" id="stageTitle${stage.id}" class="border p-2 w-full" value="${stage.title}">
            <button onclick="updateStageTitle(${stage.id})" class="bg-green-500 text-white p-2 mt-2">به‌روزرسانی عنوان</button>
          </div>
        `;
        if (['select', 'text-checkbox', 'file-checkbox'].includes(stage.type)) {
          div.innerHTML += `
            <div class="mb-2">
              <label>اضافه کردن گزینه:</label>
              <input type="text" id="optionValue${stage.id}" class="border p-2 w-full mb-2" placeholder="مقدار (value)">
              <input type="text" id="optionLabel${stage.id}" class="border p-2 w-full mb-2" placeholder="برچسب (label)">
              <button onclick="addStageOption(${stage.id})" class="bg-green-500 text-white p-2">اضافه کردن</button>
            </div>
            <ul id="stageOptions${stage.id}" class="list-disc pl-5"></ul>
          `;
          if (stage.type === 'select' && [2, 4].includes(stage.id)) {
            div.innerHTML += `
              <div id="subOptions${stage.id}"></div>
            `;
          }
        } else if (stage.type === 'double-select') {
          div.innerHTML += `
            <div class="mb-2">
              <h3 class="font-bold">حساب‌های مبدا</h3>
              <input type="text" id="sourceAccount${stage.id}" class="border p-2 w-full mb-2" placeholder="نام حساب">
              <button onclick="addSourceAccount(${stage.id})" class="bg-green-500 text-white p-2">اضافه کردن</button>
              <ul id="sourceAccountList${stage.id}" class="list-disc pl-5"></ul>
            </div>
            <div class="mb-2">
              <h3 class="font-bold">حساب‌های مقصد</h3>
              <input type="text" id="destAccount${stage.id}" class="border p-2 w-full mb-2" placeholder="نام حساب">
              <button onclick="addDestAccount(${stage.id})" class="bg-green-500 text-white p-2">اضافه کردن</button>
              <ul id="destAccountList${stage.id}" class="list-disc pl-5"></ul>
            </div>
          `;
        }
        container.appendChild(div);
        updateStageOptions(stage.id);
      });
    }

    // به‌روزرسانی گزینه‌های مرحله
    function updateStageOptions(stageId) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      if (['select', 'text-checkbox', 'file-checkbox'].includes(stage.type)) {
        const list = document.getElementById(`stageOptions${stageId}`);
        list.innerHTML = '';
        stage.options.forEach(opt => {
          list.innerHTML += `
            <li>
              ${opt.label} (${opt.value})
              <button onclick="editStageOption(${stageId}, '${opt.value}')" class="text-yellow-500">ویرایش</button>
              <button onclick="removeStageOption(${stageId}, '${opt.value}')" class="text-red-500">حذف</button>
            </li>
          `;
        });
        if (stage.type === 'select' && [2, 4].includes(stage.id)) {
          const subContainer = document.getElementById(`subOptions${stageId}`);
          subContainer.innerHTML = '';
          Object.keys(stage.options).forEach(type => {
            const div = document.createElement('div');
            div.className = 'mb-2 nested';
            div.innerHTML = `
              <h3 class="font-bold">${stages.find(s => s.id === 1).options.find(o => o.value === type)?.label || type}</h3>
              <select id="categorySelect${stageId}_${type}" class="border p-2 w-full mb-2">
                <option value="">دسته‌بندی</option>
                ${stages.find(s => s.id === 2).options[type]?.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('') || ''}
              </select>
              <input type="text" id="subOption${stageId}_${type}" class="border p-2 w-full mb-2" placeholder="بابت">
              <button onclick="addSubOption(${stageId}, '${type}')" class="bg-green-500 text-white p-2">اضافه کردن بابت</button>
              <ul id="subOptionList${stageId}_${type}" class="list-disc pl-5"></ul>
            `;
            subContainer.appendChild(div);
            const subList = document.getElementById(`subOptionList${stageId}_${type}`);
            if (stageId === 4 && type === 'تهاتری') {
              stage.options[type]['درآمد و هزینه'].forEach(item => {
                subList.innerHTML += `<li>درآمد: ${item.income}, هزینه: ${item.cost} <button onclick="removeTehaterySubOption(${stageId}, '${type}', '${item.income}', '${item.cost}')" class="text-red-500">حذف</button></li>`;
              });
            } else {
              Object.keys(stage.options[type]).forEach(category => {
                stage.options[type][category].forEach(opt => {
                  subList.innerHTML += `<li>${opt} <button onclick="removeSubOption(${stageId}, '${type}', '${category}', '${opt}')" class="text-red-500">حذف</button></li>`;
                });
              });
            }
          });
        }
      } else if (stage.type === 'double-select') {
        const sourceList = document.getElementById(`sourceAccountList${stageId}`);
        const destList = document.getElementById(`destAccountList${stageId}`);
        sourceList.innerHTML = '';
        destList.innerHTML = '';
        stage.sourceAccounts.forEach(account => {
          sourceList.innerHTML += `<li>${account} <button onclick="removeSourceAccount(${stageId}, '${account}')" class="text-red-500">حذف</button></li>`;
        });
        stage.destAccounts.forEach(account => {
          destList.innerHTML += `<li>${account} <button onclick="removeDestAccount(${stageId}, '${account}')" class="text-red-500">حذف</button></li>`;
        });
      }
    }

    // به‌روزرسانی عنوان مرحله
    function updateStageTitle(stageId) {
      const title = document.getElementById(`stageTitle${stageId}`).value;
      if (title) {
        stages.find(s => s.id === parseInt(stageId)).title = title;
        localStorage.setItem('stages', JSON.stringify(stages));
        updateDataEntry();
        refreshForm();
      }
    }

    // اضافه کردن گزینه به مرحله
    function addStageOption(stageId) {
      const value = document.getElementById(`optionValue${stageId}`).value;
      const label = document.getElementById(`optionLabel${stageId}`).value;
      if (value && label) {
        const stage = stages.find(s => s.id === parseInt(stageId));
        if (!stage.options.some(opt => opt.value === value)) {
          stage.options.push({ value, label });
          if (stageId === 1) {
            stages.find(s => s.id === 2).options[value] = [];
            stages.find(s => s.id === 4).options[value] = {};
          }
          localStorage.setItem('stages', JSON.stringify(stages));
          updateDataEntry();
          refreshForm();
          document.getElementById(`optionValue${stageId}`).value = '';
          document.getElementById(`optionLabel${stageId}`).value = '';
        }
      }
    }

    // ویرایش گزینه مرحله
    function editStageOption(stageId, oldValue) {
      const newValue = prompt('مقدار جدید (value):', oldValue);
      const newLabel = prompt('برچسب جدید (label):', stages.find(s => s.id === parseInt(stageId)).options.find(opt => opt.value === oldValue).label);
      if (newValue && newLabel) {
        const stage = stages.find(s => s.id === parseInt(stageId));
        const option = stage.options.find(opt => opt.value === oldValue);
        option.value = newValue;
        option.label = newLabel;
        if (stageId === 1) {
          const stage2 = stages.find(s => s.id === 2);
          const stage4 = stages.find(s => s.id === 4);
          stage2.options[newValue] = stage2.options[oldValue];
          stage4.options[newValue] = stage4.options[oldValue];
          delete stage2.options[oldValue];
          delete stage4.options[oldValue];
        }
        localStorage.setItem('stages', JSON.stringify(stages));
        updateDataEntry();
        refreshForm();
      }
    }

    // حذف گزینه از مرحله
    function removeStageOption(stageId, value) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      stage.options = stage.options.filter(opt => opt.value !== value);
      if (stageId === 1) {
        delete stages.find(s => s.id === 2).options[value];
        delete stages.find(s => s.id === 4).options[value];
      }
      localStorage.setItem('stages', JSON.stringify(stages));
      updateDataEntry();
      refreshForm();
    }

    // اضافه کردن زیرشاخه
    function addSubOption(stageId, type) {
      const category = document.getElementById(`categorySelect${stageId}_${type}`).value;
      const option = document.getElementById(`subOption${stageId}_${type}`).value;
      if (category && option) {
        const stage = stages.find(s => s.id === parseInt(stageId));
        if (!stage.options[type][category].includes(option)) {
          stage.options[type][category].push(option);
          localStorage.setItem('stages', JSON.stringify(stages));
          updateDataEntry();
          refreshForm();
          document.getElementById(`subOption${stageId}_${type}`).value = '';
        }
      }
    }

    // حذف زیرشاخه
    function removeSubOption(stageId, type, category, option) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      stage.options[type][category] = stage.options[type][category].filter(opt => opt !== option);
      localStorage.setItem('stages', JSON.stringify(stages));
      updateDataEntry();
      refreshForm();
    }

    // حذف زیرشاخه تهاتری
    function removeTehaterySubOption(stageId, type, income, cost) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      stage.options[type]['درآمد و هزینه'] = stage.options[type]['درآمد و هزینه'].filter(item => !(item.income === income && item.cost === cost));
      localStorage.setItem('stages', JSON.stringify(stages));
      updateDataEntry();
      refreshForm();
    }

    // اضافه کردن حساب مبدا
    function addSourceAccount(stageId) {
      const account = document.getElementById(`sourceAccount${stageId}`).value;
      if (account) {
        const stage = stages.find(s => s.id === parseInt(stageId));
        if (!stage.sourceAccounts.includes(account)) {
          stage.sourceAccounts.push(account);
          localStorage.setItem('stages', JSON.stringify(stages));
          updateDataEntry();
          refreshForm();
          document.getElementById(`sourceAccount${stageId}`).value = '';
        }
      }
    }

    // حذف حساب مبدا
    function removeSourceAccount(stageId, account) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      stage.sourceAccounts = stage.sourceAccounts.filter(a => a !== account);
      localStorage.setItem('stages', JSON.stringify(stages));
      updateDataEntry();
      refreshForm();
    }

    // اضافه کردن حساب مقصد
    function addDestAccount(stageId) {
      const account = document.getElementById(`destAccount${stageId}`).value;
      if (account) {
        const stage = stages.find(s => s.id === parseInt(stageId));
        if (!stage.destAccounts.includes(account)) {
          stage.destAccounts.push(account);
          localStorage.setItem('stages', JSON.stringify(stages));
          updateDataEntry();
          refreshForm();
          document.getElementById(`destAccount${stageId}`).value = '';
        }
      }
    }

    // حذف حساب مقصد
    function removeDestAccount(stageId, account) {
      const stage = stages.find(s => s.id === parseInt(stageId));
      stage.destAccounts = stage.destAccounts.filter(a => a !== account);
      localStorage.setItem('stages', JSON.stringify(stages));
      updateDataEntry();
      refreshForm();
    }

    // تابع برای رفرش کردن فرم
    function refreshForm() {
      const rowCount = transactions.length + 1;
      document.getElementById('transactionBody').innerHTML = `
        <tr id="row${rowCount}">
          <td><button onclick="startForm(${rowCount})" class="bg-green-500 text-white p-2">شروع</button></td>
          <td>
            <div id="form${rowCount}" class="p-2 hidden">
              <div id="step1_${rowCount}" class="mb-2">
                <label id="stage1Label">مرحله 1: نوع تراکنش</label>
                <select id="type${rowCount}" onchange="showTypeOptions(${rowCount})" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="nextStep(${rowCount}, 1, 2)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step2_${rowCount}" class="hidden mb-2">
                <label id="stage2Label">مرحله 2: دسته‌بندی</label>
                <select id="category${rowCount}" onchange="updateReasonOptions(${rowCount})" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(${rowCount}, 2, 1)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 2, 3)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step3_${rowCount}" class="hidden mb-2">
                <label id="stage3Label">مرحله 3: مبلغ (ریال)</label>
                <input type="text" id="amount${rowCount}" oninput="formatAmount(${rowCount})" class="border p-2 w-full" placeholder="مثال: 200,000">
                <p id="amountText${rowCount}" class="text-sm text-gray-600 mt-1"></p>
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="confirmAmount${rowCount}" class="mr-2">
                  <span>مبلغ واردشده درست است</span>
                </label>
                <button onclick="goBack(${rowCount}, 3, 2)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 3, 4)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step4_${rowCount}" class="hidden mb-2">
                <label id="reasonLabel${rowCount}">مرحله 4: بابت</label>
                <select id="reason${rowCount}" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(${rowCount}, 4, 3)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 4, 5)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step5_${rowCount}" class="hidden mb-2">
                <label id="stage5SourceLabel">مرحله 5: حساب مبدا</label>
                <select id="sourceAccount${rowCount}" class="border p-2 w-full mb-2">
                  <option value="">انتخاب کنید</option>
                </select>
                <label id="stage5DestLabel">حساب مقصد</label>
                <select id="destAccount${rowCount}" class="border p-2 w-full">
                  <option value="">انتخاب کنید</option>
                </select>
                <button onclick="goBack(${rowCount}, 5, 4)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 5, 6)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step6_${rowCount}" class="hidden mb-2">
                <label id="stage6Label">مرحله 6: شماره فاکتور/رسید</label>
                <input type="text" id="invoice${rowCount}" class="border p-2 w-full">
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="noInvoice${rowCount}" class="mr-2" onchange="toggleInvoice(${rowCount})">
                  <span>فاقد شماره فاکتور/رسید</span>
                </label>
                <button onclick="goBack(${rowCount}, 6, 5)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 6, 7)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step7_${rowCount}" class="hidden mb-2">
                <label id="stage7Label">مرحله 7: آپلود مدارک</label>
                <input type="file" id="document${rowCount}" class="border p-2 w-full">
                <label class="flex items-center mt-2">
                  <input type="checkbox" id="noDocument${rowCount}" class="mr-2" onchange="toggleDocument(${rowCount})">
                  <span>فاقد مدارک</span>
                </label>
                <button onclick="goBack(${rowCount}, 7, 6)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="nextStep(${rowCount}, 7, 8)" class="bg-blue-500 text-white p-2 mt-2">بعدی</button>
              </div>
              <div id="step8_${rowCount}" class="hidden mb-2">
                <label id="stage8Label">مرحله 8: توضیحات</label>
                <textarea id="description${rowCount}" class="border p-2 w-full" rows="4" placeholder="توضیحات (اختیاری)"></textarea>
                <button onclick="goBack(${rowCount}, 8, 7)" class="bg-gray-500 text-white p-2 mt-2">قبلی</button>
                <button onclick="saveTransaction(${rowCount})" class="bg-green-500 text-white p-2 mt-2